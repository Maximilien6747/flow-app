<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Espace de cours — Onboarding</title>
  <style>
    :root{
      /* Couleurs dynamiques (modifiées par JS pour le thème) */
      --bg: #f0d0ff;
      --card: #f4ddff;
      --text: #0b0b0b;
      --accent: #8b5cf6; /* violet par défaut */
      --outline: color-mix(in oklab, var(--accent) 50%, transparent);
    }

    /* Reset + base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    /* Contrainte mobile type iPhone */
    .frame{
      min-height:100dvh;
      max-width: 430px;   /* format iPhone */
      margin:0 auto;
      padding:24px 18px 28px;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    /* Bulle générique */
    .bubble{
      background:var(--card);
      border-radius:20px;
      padding:18px 20px;
      box-shadow: 0 2px 0 0 rgba(0,0,0,.08) inset, 0 1px 10px rgba(0,0,0,.06);
      border: 3px solid color-mix(in oklab, var(--card) 80%, #000 20%);
    }

    .title{
      font-weight:900;
      font-size: clamp(22px, 5.8vw, 34px);
      line-height:1.15;
      text-align:center;
    }

    .big-title{
      font-weight:900;
      font-size: clamp(28px, 7vw, 42px);
      text-align:center;
      margin: 8px 0 2px;
    }

    .center{ text-align:center }

    /* Carte fonction (cours / edt / devoirs / contrôles) */
    .card{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:18px 20px;
      border-radius:16px;
      background:var(--card);
      border:2.5px solid var(--outline);
    }
    .card .label{
      font-size: clamp(20px,5.4vw,28px);
      font-weight:900;
    }
    .card .emoji{
      font-size:32px;
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.2));
    }

    /* Bouton continuer */
    .cta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding:16px 20px;
      border-radius:16px;
      background:var(--card);
      border:3px solid var(--outline);
      font-weight:900;
      font-size: clamp(20px,5vw,26px);
      cursor:pointer;
      user-select:none;
    }
    .cta .arrow{
      width:48px;height:40px;
      border-radius:999px;
      border:3px solid var(--text);
      display:grid;place-items:center;
    }
    .cta:active{ transform: translateY(1px) }

    /* Choix Allemand / Espagnol */
    .choice{
      display:grid; gap:14px;
    }
    .choice button{
      border-radius:16px;
      padding:16px 20px;
      font-weight:900;
      font-size: clamp(20px,5.4vw,28px);
      background:var(--card);
      border:3px solid var(--outline);
      cursor:pointer;
    }
    .choice button.active{
      outline:4px solid #55c34a;
      outline-offset:2px;
    }

    /* Input prénom */
    .input{
      width:100%;
      border-radius:14px;
      padding:16px 16px;
      border:2.5px solid color-mix(in oklab, var(--card) 60%, #000 40%);
      background: color-mix(in oklab, var(--card) 82%, #fff 18%);
      font-size:20px;
      font-weight:700;
    }

    /* Palette thème */
    .palette{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
      padding:8px 0 2px;
    }
    .swatch{
      height:60px;border-radius:50%;
      border:3px solid rgba(0,0,0,.22);
      cursor:pointer;
    }
    .mode-row{
      display:flex; gap:10px; justify-content:center; margin:8px 0 2px;
    }
    .mode{
      padding:8px 14px; border-radius:999px; font-weight:800; cursor:pointer;
      border:3px solid var(--outline); background:var(--card)
    }
    .mode.active{ outline:4px solid var(--text); outline-offset:2px }

    /* Étapes & animations */
    #stage{ position:relative; min-height:100dvh }
    .step{
      position:absolute; inset:0;
      display:flex; flex-direction:column; gap:18px;
      padding:24px 18px 28px;
      overflow:hidden;
      max-width:430px; margin:0 auto;
    }
    .step-enter{
      opacity:0; transform: translateY(40px);
    }
    .step-enter-active{
      transition:.45s cubic-bezier(.2,.8,.2,1);
      opacity:1; transform: translateY(0);
    }
    .step-exit{
      opacity:1; transform: translateY(0);
    }
    .step-exit-active{
      transition:.45s cubic-bezier(.2,.8,.2,1);
      opacity:0; transform: translateY(-38px);
    }

    /* Helpers de spacing pour “bulles” */
    .sp-xxl{ height:2px } /* fine */

    /* Accessibilité simple */
    button, .cta{ color:var(--text) }
  </style>
</head>
<body>
  <main id="stage" aria-live="polite"></main>

  <script>
    /* --------- Thème dynamique (Light / Dark + couleur accent) --------- */
    const state = {
      prenom: localStorage.getItem('prenom') || '',
      langue: localStorage.getItem('langue') || '',  // "allemand" | "espagnol"
      theme: JSON.parse(localStorage.getItem('theme') || '{"mode":"light","accent":"#8b5cf6"}')
    };

    function clamp01(x){ return Math.max(0,Math.min(1,x)) }

    // Convert hex -> hsl et l'inverse pour éclaircir/assombrir simplement
    function hexToHsl(hex){
      hex = hex.replace('#','');
      if (hex.length===3) hex = hex.split('').map(c=>c+c).join('');
      const r = parseInt(hex.slice(0,2),16)/255;
      const g = parseInt(hex.slice(2,4),16)/255;
      const b = parseInt(hex.slice(4,6),16)/255;
      const max = Math.max(r,g,b), min=Math.min(r,g,b);
      let h,s,l=(max+min)/2;
      if (max===min){ h=s=0; }
      else{
        const d = max-min;
        s = l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d+(g<b?6:0); break;
          case g: h=(b-r)/d+2; break;
          case b: h=(r-g)/d+4; break;
        }
        h/=6;
      }
      return {h,s,l}
    }
    function hslToHex(h,s,l){
      function hue2rgb(p, q, t){
        if (t<0) t+=1; if (t>1) t-=1;
        if (t<1/6) return p+(q-p)*6*t;
        if (t<1/2) return q;
        if (t<2/3) return p+(q-p)*(2/3 - t)*6;
        return p;
      }
      let r,g,b;
      if (s===0){ r=g=b=l; }
      else{
        const q = l < .5 ? l*(1+s) : l+s - l*s;
        const p = 2*l - q;
        r = hue2rgb(p, q, h+1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h-1/3);
      }
      const toHex = x => ('0'+Math.round(x*255).toString(16)).slice(-2);
      return '#'+toHex(r)+toHex(g)+toHex(b);
    }

    function applyTheme(mode, accentHex){
      const a = hexToHsl(accentHex);
      // Couleurs calculées
      let bg, card, text;
      if (mode === 'dark'){
        text = '#ffffff';
        const base = {h:a.h, s: clamp01(a.s*0.65), l: 0.18};
        bg   = hslToHex(base.h, base.s, base.l);
        card = hslToHex(base.h, clamp01(base.s*0.55), 0.34);
      } else {
        text = '#0b0b0b';
        bg   = hslToHex(a.h, clamp01(a.s*0.35), 0.88);
        card = hslToHex(a.h, clamp01(a.s*0.30), 0.92);
      }
      document.documentElement.style.setProperty('--bg', bg);
      document.documentElement.style.setProperty('--card', card);
      document.documentElement.style.setProperty('--text', text);
      document.documentElement.style.setProperty('--accent', accentHex);
      document.documentElement.style.setProperty('--outline', accentHex+'55');
      state.theme = {mode, accent: accentHex};
      localStorage.setItem('theme', JSON.stringify(state.theme));
    }

    // Appliquer le thème au chargement
    applyTheme(state.theme.mode, state.theme.accent);

    /* --------------------- Gestion du flux / étapes --------------------- */
    const stage = document.getElementById('stage');
    let stepIndex = 0;

    // Utilitaires anim
    function mountStep(el){
      el.classList.add('step','step-enter');
      stage.appendChild(el);
      requestAnimationFrame(()=> el.classList.add('step-enter-active'));
    }
    function replaceStep(nextEl){
      const current = stage.querySelector('.step');
      if (!current){ mountStep(nextEl); return; }
      current.classList.remove('step-enter','step-enter-active');
      current.classList.add('step-exit');
      requestAnimationFrame(()=> current.classList.add('step-exit-active'));
      current.addEventListener('transitionend', ()=> current.remove(), {once:true});
      mountStep(nextEl);
    }

    function bubble(titleText){
      const d = document.createElement('div');
      d.className = 'bubble';
      d.innerHTML = `<div class="title">${titleText}</div>`;
      return d;
    }
    function cta(label, onClick){
      const d = document.createElement('div');
      d.className = 'cta';
      d.role = 'button';
      d.tabIndex = 0;
      d.innerHTML = `<div>${label}</div><div class="arrow">➜</div>`;
      d.addEventListener('click', onClick);
      d.addEventListener('keypress', (e)=>{ if(e.key==='Enter' || e.key===' ') onClick(); });
      return d;
    }
    function card(label, emoji){
      const d = document.createElement('div');
      d.className = 'card';
      d.innerHTML = `<div class="label">${label}</div><div class="emoji">${emoji}</div>`;
      return d;
    }

    /* --------------------------- Les étapes ---------------------------- */
    const steps = [
      /* 0 — Accueil */
      () => {
        const el = document.createElement('section');
        el.innerHTML = '';
        el.append(
          (()=>{ const b=bubble(`Bienvenu dans ton espace de cours.`); b.querySelector('.title').classList.add('big-title'); return b; })(),
          card('continuer',''),
        );
        el.querySelector('.card').replaceWith(
          (()=>{ const d = document.createElement('div'); d.appendChild(cta('continuer', next)); return d; })()
        );
        return el;
      },

      /* 1 — Prénom */
      () => {
        const el = document.createElement('section');
        const b = bubble(`quel est ton prénom ?`);
        const input = document.createElement('input');
        input.className = 'input';
        input.placeholder = 'Ton prénom';
        input.value = state.prenom;
        input.autocapitalize = 'words';
        input.autocomplete = 'given-name';
        const wrap = document.createElement('div'); wrap.className='bubble'; wrap.appendChild(input);
        el.append(b, wrap, cta('continuer', ()=> {
          const v = input.value.trim();
          if(!v){ input.focus(); input.style.outline='3px solid #ff7272'; setTimeout(()=>input.style.outline='',600); return; }
          state.prenom = v;
          localStorage.setItem('prenom', v);
          next();
        }));
        setTimeout(()=>input.focus(), 100);
        return el;
      },

      /* 2 — Allemand ou Espagnol */
      () => {
        const el = document.createElement('section');
        const b = document.createElement('div'); b.className='bubble';
        b.innerHTML = `<div class="big-title">bienvenu ${state.prenom||'à toi'}</div>
                       <div class="title" style="margin-top:8px">tu fais ?</div>`;
        const ch = document.createElement('div'); ch.className='choice';
        const btnA = document.createElement('button'); btnA.textContent='Allemand';
        const btnE = document.createElement('button'); btnE.textContent='Espagnol';
        if(state.langue==='allemand') btnA.classList.add('active');
        if(state.langue==='espagnol') btnE.classList.add('active');
        btnA.onclick = ()=>{ state.langue='allemand'; btnA.classList.add('active'); btnE.classList.remove('active'); };
        btnE.onclick = ()=>{ state.langue='espagnol'; btnE.classList.add('active'); btnA.classList.remove('active'); };
        ch.append(btnA, btnE);
        const go = cta('continuer', ()=>{
          if(!state.langue){ btnA.focus(); return;}
          localStorage.setItem('langue', state.langue);
          next();
        });
        el.append(b, ch, go);
        return el;
      },

      /* 3 — Présentation : cours */
      () => {
        const el = document.createElement('section');
        el.append(
          bubble(`tu trouvera ici tout tes cours depuis le debut de l’année`),
          card('cours','📘'),
          cta('continuer', next)
        );
        return el;
      },

      /* 4 — Présentation : emploi du temps */
      () => {
        const el = document.createElement('section');
        el.append(
          bubble(`tu trouvera aussi ton emploie du temps`),
          card('emploie du temps','🗓️'),
          cta('continuer', next)
        );
        return el;
      },

      /* 5 — Présentation : devoirs */
      () => {
        const el = document.createElement('section');
        el.append(
          bubble(`tout tes devoirs deja fais et expliquée`),
          card('devoirs','✏️'),
          cta('continuer', next)
        );
        return el;
      },

      /* 6 — Présentation : contrôles */
      () => {
        const el = document.createElement('section');
        el.append(
          bubble(`ainsi que tout tes controles a venir avec des fiches de  revisions`),
          card('controle','📝'),
          cta('continuer', next)
        );
        return el;
      },

      /* 7 — Choix du thème (aperçu immédiat) */
      () => {
        const el = document.createElement('section');
        const b = bubble(`choisi des maintenant le theme de ton application`);
        const box = document.createElement('div'); box.className='bubble';
        // Modes
        const modes = document.createElement('div'); modes.className='mode-row';
        const mLight = document.createElement('button'); mLight.className='mode'; mLight.textContent='Clair';
        const mDark  = document.createElement('button'); mDark.className='mode';  mDark.textContent='Sombre';
        const setModeBtn = ()=>{
          mLight.classList.toggle('active', state.theme.mode==='light');
          mDark .classList.toggle('active', state.theme.mode==='dark');
        }
        mLight.onclick=()=>{ applyTheme('light', state.theme.accent); setModeBtn(); };
        mDark .onclick=()=>{ applyTheme('dark',  state.theme.accent); setModeBtn(); };
        setModeBtn();
        modes.append(mLight,mDark);

        // Palette
        const palette = document.createElement('div'); palette.className='palette';
        const colors = ['#ffffff','#111111','#23a6ff','#ff3b30','#c084fc','#a3e635','#ff7a18','#ff59c7'];
        colors.forEach(hex=>{
          const s = document.createElement('button'); s.className='swatch'; s.style.background=hex;
          s.title = hex;
          s.onclick=()=>{ applyTheme(state.theme.mode, hex); };
          palette.appendChild(s);
        });

        box.append(modes, palette);
        el.append(b, box, cta('continuer', ()=> {
          // Fin de l’onboarding : ici tu pourras rediriger vers l’app principale
          // Pour l’instant on repart au début.
          stepIndex = -1; // sera ++ dans next()
          next();
        }));
        return el;
      },
    ];

    function next(){
      stepIndex++;
      if (stepIndex >= steps.length) stepIndex = 0;
      const node = steps[stepIndex]();
      replaceStep(node);
      // Focus léger sur le premier élément interactif
      setTimeout(()=>{
        const first = stage.querySelector('.step').querySelector('input,button,.cta');
        if (first && first.focus) first.focus();
      }, 50);
    }

    // Lancement
    next();
  </script>
</body>
</html>
