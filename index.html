<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Espace de cours</title>
  <style>
    :root{
      --pad:18px; --safe-top:env(safe-area-inset-top); --safe-bottom:env(safe-area-inset-bottom);
      --ink:#000; --bg:#fff; --fg:#111;
      --radius:18px; --thick:4px; --dur:300ms; --ease:cubic-bezier(.2,.7,.3,1);
      --gap:10px;
      --c-fr:#fac3cf; --c-his:#ffd9b3; --c-svt:#c9f0db; --c-chi:#fff3b8;
      --c-snt:#cfeeff; --c-ses:#f1dbff; --c-ang:#ffc6e9;
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:700 clamp(16px,2.6vw,18px)/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .app{
      max-width: 400px;
      margin: 0 auto;
      padding: calc(var(--safe-top) + var(--pad)) var(--pad) calc(var(--safe-bottom) + var(--pad));
      min-height: 100svh;
      position: relative;
    }
    header.bar{
      position: sticky; top: calc(var(--safe-top) + 6px);
      display:flex; gap:8px; align-items:center; justify-content:flex-start;
      z-index:5;
    }
    .iconBtn{
      width:40px;height:40px;border:3px solid var(--ink);
      border-radius:50%; display:grid; place-items:center;
      background:#fff; color:#000; cursor:pointer;
    }
    #backBtn{ visibility:hidden; }

    h1{margin:14px 0 20px; font-size:clamp(26px,7vw,36px); line-height:1.1; text-align:center}
    h2{margin:6px 0 14px; font-size:clamp(22px,6.5vw,30px); text-align:center}

    label{display:block; margin:8px 0 6px}
    input[type="text"], input[type="file"]{
      width:100%; padding:14px; border-radius:16px;
      border:var(--thick) solid var(--ink);
      background:#ececec; font: 800 17px/1.2 system-ui; color:#000; outline:none;
    }
    .btn{
      margin-top:14px; padding:12px 16px; border:3px solid var(--ink);
      border-radius:14px; background:#000; color:#fff; font:800 17px system-ui; cursor:pointer;
      width:fit-content;
    }
    .btn.secondary{background:#fff; color:#000}
    .btn:active{transform:translateY(1px)}
    .hint{margin-top:8px; opacity:.65; font-weight:600}

    /* pile + transitions */
    .stack{ position:relative }
    .screen{
      position:absolute; inset:0; opacity:0; pointer-events:none; transform:translateX(40px);
      display:flex; flex-direction:column;
    }
    .screen.active{ opacity:1; pointer-events:auto; transform:none }
    .anim-out-left{animation:outLeft var(--dur) var(--ease) both}
    .anim-in-right{animation:inRight var(--dur) var(--ease) both}
    .anim-out-right{animation:outRight var(--dur) var(--ease) both}
    .anim-in-left{animation:inLeft var(--dur) var(--ease) both}
    @keyframes outLeft{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-40px)}}
    @keyframes inRight{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
    @keyframes outRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}
    @keyframes inLeft{from{opacity:0;transform:translateX(-40px)}to{opacity:1;transform:translateX(0)}}

    .center{ flex:1; display:flex; flex-direction:column; justify-content:center; gap:16px }

    /* cartes */
    .menu{display:flex; flex-direction:column; gap:14px}
    .cardLink, .mat{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px; background:#e5e5e5; border:var(--thick) solid var(--ink);
      border-radius:20px; text-decoration:none; color:#000; cursor:pointer;
      font-size:clamp(18px,5vw,22px); font-weight:900; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pillArrow{min-width:52px;height:38px;border:3px solid var(--ink);border-radius:999px;display:grid;place-items:center;background:#fff;color:#000}
    .list{display:flex;flex-direction:column;gap:12px;margin-top:6px}
    .left{display:flex;align-items:center;gap:10px}
    .icon{font-size:1.1em}

    .subjectTitle{ font-size: clamp(28px,8vw,38px); text-align:center; margin: 6px 0 8px }

    /* grille de cours */
    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); margin-top:6px }
    .gridItem{
      position:relative; overflow:hidden; background:#dcdcdc;
      border:var(--thick) solid var(--ink); border-radius:14px; aspect-ratio:3/4; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .gridItem img{ width:100%; height:100%; object-fit:cover; display:block }
    .delBtn{
      position:absolute; top:6px; right:6px;
      width:30px; height:30px; border-radius:50%;
      border:3px solid var(--ink); background:#fff; color:#000;
      display:none; place-items:center; font-size:14px; cursor:pointer;
    }
    .gridItem.admin .delBtn{ display:grid; }

    /* FAB */
    .fab{
      position:fixed; right:22px; bottom:calc(22px + var(--safe-bottom));
      width:56px;height:56px;border-radius:50%; border:3px solid var(--ink);
      background:#000; color:#fff; display:none; place-items:center; font-size:26px;
      box-shadow:0 8px 18px rgba(0,0,0,.18); cursor:pointer; z-index:7;
    }

    /* modales */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:8}
    .modal .box{background:#fff; color:#000; border:var(--thick) solid var(--ink); border-radius:18px; padding:16px; width:min(92vw,380px)}
    .modal .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}

    /* viewer image */
    .viewer{position:fixed; inset:0; background:#000; display:none; align-items:center; justify-content:center; z-index:9}
    .viewer img{max-width:96vw; max-height:90vh; border-radius:12px}
    .viewer .close{position:fixed; top:16px; right:16px; width:42px;height:42px;border:3px solid #fff;border-radius:50%;color:#fff;display:grid;place-items:center;cursor:pointer}
  </style>
</head>
<body>
  <main class="app">
    <header class="bar">
      <button id="gear" class="iconBtn" title="Param√®tres">‚öôÔ∏è</button>
      <button id="backBtn" class="iconBtn" aria-label="Retour">‚Üê</button>
    </header>

    <div id="stack" class="stack" aria-live="polite" aria-atomic="true">
      <!-- 1) pr√©nom -->
      <section id="scr-welcome" class="screen active">
        <div class="center">
          <h1>Bienvenue dans ton espace de cours</h1>
          <div>
            <label for="prenom">Quel est ton pr√©nom ?</label>
            <input id="prenom" type="text" placeholder="Ton pr√©nom" autocomplete="given-name">
            <button id="go" class="btn">Continuer</button>
            <div id="msg" class="hint"></div>
          </div>
        </div>
      </section>

      <!-- 2) menu -->
      <section id="scr-home" class="screen" aria-hidden="true">
        <div class="center">
          <h2>Bonjour <span id="who">prenom</span></h2>
          <nav class="menu">
            <button id="btn-cours"   class="cardLink" type="button">cours <span class="pillArrow">‚Üí</span></button>
            <button id="btn-emploi"  class="cardLink" type="button">emploie du temps <span class="pillArrow">‚Üí</span></button>
            <button id="btn-devoirs" class="cardLink" type="button">devoirs <span class="pillArrow">‚Üí</span></button>
            <button id="btn-controle"class="cardLink" type="button">controle <span class="pillArrow">‚Üí</span></button>
          </nav>
        </div>
      </section>

      <!-- 3) liste des mati√®res -->
      <section id="scr-cours" class="screen" aria-hidden="true">
        <h2 style="margin-top:4px">Cours</h2>
        <div id="mat-list" class="list"></div>
      </section>

      <!-- 4) chapitres d'une mati√®re -->
      <section id="scr-chapters" class="screen" aria-hidden="true">
        <h2 id="chapTitle" class="subjectTitle">chapitres</h2>
        <div id="chap-list" class="list"></div>
      </section>

      <!-- 5) cours (grille 3 colonnes) -->
      <section id="scr-courses" class="screen" aria-hidden="true">
        <h2 id="courseTitle" class="subjectTitle">cours</h2>
        <div id="grid" class="grid"></div>
      </section>
    </div>

    <!-- FAB (ajout chapitre OU ajout cours) -->
    <button id="fabAdd" class="fab" title="Ajouter">Ôºã</button>

    <!-- Modal param√®tres -->
    <div id="modalGear" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Param√®tres</h3>
        <div id="adminRow"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="gearClose">Fermer</button>
        </div>
      </div>
    </div>

    <!-- Modal admin -->
    <div id="modalAdmin" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Mode admin</h3>
        <label for="adminCode">Code</label>
        <input id="adminCode" type="text" inputmode="numeric" maxlength="8" placeholder="Code admin">
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="adminCancel">Annuler</button>
          <button class="btn" id="adminOk">Valider</button>
        </div>
        <div id="adminMsg" class="hint"></div>
      </div>
    </div>

    <!-- Modal ajout CHAPITRE -->
    <div id="modalChapter" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Ajouter un chapitre</h3>
        <label for="chapName">Nom du chapitre</label>
        <input id="chapName" type="text" placeholder="Ex. Chapitre 1">
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="chapCancel">Annuler</button>
          <button class="btn" id="chapSave">Enregistrer</button>
        </div>
        <div id="chapMsg" class="hint"></div>
      </div>
    </div>

    <!-- Modal ajout COURS (multi) -->
    <div id="modalAdd" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Ajouter des cours</h3>
        <label>Images (une ou plusieurs)</label>
        <input id="addImg" type="file" accept="image/*" capture="environment" multiple>
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="addCancel">Annuler</button>
          <button class="btn" id="addSave">Enregistrer</button>
        </div>
        <div id="addMsg" class="hint"></div>
      </div>
    </div>

    <!-- Viewer image -->
    <div id="viewer" class="viewer">
      <button class="close" id="viewerClose">‚úï</button>
      <img id="viewerImg" alt="Cours">
    </div>
  </main>

  <script type="module">
    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, query, orderBy, onSnapshot,
      doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdfzyOuEWW7kcvPAxruh_Oxz3WJHyMBnE",
      authDomain: "app-cours-94f32.firebaseapp.com",
      projectId: "app-cours-94f32",
      storageBucket: "app-cours-94f32.firebasestorage.app",
      messagingSenderId: "519755746540",
      appId: "1:519755746540:web:8d55f18754ce08884269c9",
      measurementId: "G-VD89GYHJWV"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------- helpers UI ---------- */
    const $ = s => document.querySelector(s);
    const stack = $('#stack'), backBtn = $('#backBtn');

    function setStackHeight(h){ stack.style.height = h+'px'; }
    const navStack = ['scr-welcome'];
    function activeId(){ return navStack[navStack.length-1]; }
    function activeScreen(){ return document.getElementById(activeId()); }
    function canGoBack(){ return navStack.length>1; }
    function refreshBack(){ backBtn.style.visibility = canGoBack() ? 'visible' : 'hidden'; }
    function animate(fromEl,toEl,dir){
      setStackHeight(Math.max(fromEl.scrollHeight,toEl.scrollHeight));
      fromEl.classList.remove('active'); toEl.classList.add('active');
      const o = dir==='f' ? 'anim-out-left':'anim-out-right';
      const i = dir==='f' ? 'anim-in-right':'anim-in-left';
      fromEl.classList.add(o); toEl.classList.add(i);
      toEl.addEventListener('animationend',()=>{
        fromEl.classList.remove(o); toEl.classList.remove(i);
        setStackHeight(toEl.scrollHeight);
      },{once:true});
    }
    function go(id,dir='f'){ const a=activeScreen(); const b=document.getElementById(id); if(a===b) return; navStack.push(id); animate(a,b,dir); refreshBack(); toggleFab(); }
    function back(){ if(!canGoBack()) return; const a=activeScreen(); navStack.pop(); const b=activeScreen(); animate(a,b,'b'); refreshBack(); toggleFab(); }
    backBtn.onclick = back;

    /* ---------- Etat ----------- */
    const who = $('#who'), prenomInput = $('#prenom'), msg = $('#msg');
    let isAdminUI = false;

    let currentSubject = null;         // slug de mati√®re
    let currentSubjectName = null;
    let currentChapter = null;         // { id, name }
    let unsubscribe = null;

    // m√©moires pour order
    const chapterOrderMaxBySubject = {};                  // key: subjectSlug => max(order) pour chapitres
    const courseOrderMaxByChap = {};                      // key: subjectSlug/chapterId => max(order) pour cours

    const subjects = [
      {slug:'francais', name:'francais', color:'var(--c-fr)',  icon:'üìö'},
      {slug:'histoire', name:'histoire', color:'var(--c-his)', icon:'üèõÔ∏è'},
      {slug:'svt',      name:'SVT',      color:'var(--c-svt)', icon:'üß¨'},
      {slug:'chimie',   name:'Chimie',   color:'var(--c-chi)', icon:'‚öóÔ∏è'},
      {slug:'snt',      name:'SNT',      color:'var(--c-snt)', icon:'üíª'},
      {slug:'ses',      name:'SES',      color:'var(--c-ses)', icon:'üìà'},
      {slug:'anglais',  name:'Anglais',  color:'var(--c-ang)', icon:'üá¨üáß'}
    ];

    /* ---------- Accueil ---------- */
    function saveAndGo(){
      const name = (prenomInput.value||'').trim();
      if(!name){ msg.textContent = "Entre ton pr√©nom pour continuer."; return; }
      localStorage.setItem('prenom', name);
      who.textContent = name;
      msg.textContent = '';
      go('scr-home','f');
    }
    $('#go').onclick = saveAndGo;
    prenomInput.addEventListener('keydown', e=>{ if(e.key==='Enter') saveAndGo(); });

    /* ---------- Menu ---------- */
    $('#btn-cours').onclick   = ()=>{ renderMatieres(); go('scr-cours','f'); };
    $('#btn-emploi').onclick  = ()=> alert('√âcran "emploie du temps" √† venir');
    $('#btn-devoirs').onclick = ()=> alert('√âcran "devoirs" √† venir');
    $('#btn-controle').onclick= ()=> alert('√âcran "controle" √† venir');

    function renderMatieres(){
      const wrap = $('#mat-list'); wrap.innerHTML='';
      for(const s of subjects){
        const b = document.createElement('button');
        b.className='mat'; b.type='button'; b.style.background = s.color;
        b.innerHTML = `<span class="left"><span>${s.name}</span> <span class="icon">${s.icon}</span></span>
                       <span class="pillArrow">‚Üí</span>`;
        b.onclick = ()=> openSubject(s.slug, s.name);
        wrap.appendChild(b);
      }
    }

    /* ---------- Chapitres ---------- */
    function openSubject(slug, name){
      currentSubject = slug; currentSubjectName = name;
      $('#chapTitle').textContent = `${name} ‚Äî chapitres`;
      renderChapters();
      go('scr-chapters','f');
      setTimeout(()=>setStackHeight(activeScreen().scrollHeight),10);
    }

    function renderChapters(){
      if (unsubscribe) { unsubscribe(); unsubscribe=null; }
      const list = $('#chap-list'); list.innerHTML='';
      const q = query(collection(db, `subjects/${currentSubject}/chapters`), orderBy("order","asc"));
      unsubscribe = onSnapshot(q, snap=>{
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        // MAJ max(order)
        chapterOrderMaxBySubject[currentSubject] =
          arr.reduce((acc,it)=>Math.max(acc, typeof it.order==='number'?it.order:-1), -1);

        list.innerHTML='';
        if(!arr.length){
          list.innerHTML = '<div class="hint" style="margin:8px auto">Aucun chapitre pour le moment.</div>';
        } else {
          for(const ch of arr){
            const btn = document.createElement('button');
            btn.className='mat'; btn.type='button';
            btn.innerHTML = `<span class="left"><span>${ch.name}</span></span><span class="pillArrow">‚Üí</span>`;
            btn.onclick = ()=> openChapter(ch.id, ch.name);
            list.appendChild(btn);
          }
        }
        setTimeout(()=>setStackHeight(activeScreen().scrollHeight),10);
      });
    }

    function openChapter(chapterId, chapterName){
      currentChapter = { id: chapterId, name: chapterName };
      $('#courseTitle').textContent = `${currentSubjectName} ‚Äî ${chapterName}`;
      renderCourses();
      go('scr-courses','f');
      setTimeout(()=>setStackHeight(activeScreen().scrollHeight),10);
    }

    /* ---------- Cours (grille) ---------- */
    const grid = $('#grid');

    function renderCourses(){
      if (unsubscribe) { unsubscribe(); unsubscribe=null; }
      grid.innerHTML='';
      const path = `subjects/${currentSubject}/chapters/${currentChapter.id}/courses`;
      const q = query(collection(db, path), orderBy("order","asc"));
      unsubscribe = onSnapshot(q, snap=>{
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        // MAJ max(order) pour ce chapitre
        const key = `${currentSubject}/${currentChapter.id}`;
        courseOrderMaxByChap[key] =
          arr.reduce((acc,it)=>Math.max(acc, typeof it.order==='number'?it.order:-1), -1);

        grid.innerHTML='';
        if(!arr.length){
          grid.innerHTML = '<div class="hint" style="margin:8px auto">Aucun cours pour le moment.</div>';
        } else {
          for(const it of arr){
            const item = document.createElement('div');
            item.className = 'gridItem' + (isAdminUI ? ' admin' : '');
            const im = new Image(); im.src = it.img; item.appendChild(im);

            const del = document.createElement('button');
            del.className = 'delBtn'; del.title='Supprimer'; del.textContent='üóëÔ∏è';
            del.onclick = async (e)=>{ e.stopPropagation();
              if(confirm('Supprimer ce cours ?')){
                await deleteDoc(doc(db, path, it.id));
              }
            };
            item.appendChild(del);

            item.onclick = ()=> openViewer(it.img);
            grid.appendChild(item);
          }
        }
        setTimeout(()=>setStackHeight(activeScreen().scrollHeight),10);
      });
    }

    /* ---------- viewer ---------- */
    function openViewer(src){ if(!src) return; $('#viewerImg').src=src; $('#viewer').style.display='flex'; }
    $('#viewerClose').onclick = ()=> $('#viewer').style.display='none';

    /* ---------- Param√®tres + Admin ---------- */
    const modalGear = $('#modalGear'), adminRow = $('#adminRow');
    function refreshGear(){
      adminRow.innerHTML='';
      const b = document.createElement('button');
      b.className='btn'; b.textContent = isAdminUI ? 'Quitter admin' : 'Admin';
      b.onclick = ()=>{
        if(isAdminUI){ isAdminUI=false; modalGear.style.display='none'; toggleFab(); refreshAdminFlags(); }
        else{ modalGear.style.display='none'; openAdminModal(); }
      };
      adminRow.appendChild(b);
    }
    function refreshAdminFlags(){
      // toggle l'affichage des poubelles quand on bascule admin
      [...document.querySelectorAll('.gridItem')].forEach(el=>{
        if(isAdminUI) el.classList.add('admin'); else el.classList.remove('admin');
      });
    }
    function openAdminModal(){
      $('#adminCode').value=''; $('#adminMsg').textContent='';
      $('#modalAdmin').style.display='flex';
    }
    $('#gear').onclick = ()=>{ refreshGear(); modalGear.style.display='flex'; };
    $('#gearClose').onclick = ()=> modalGear.style.display='none';
    $('#adminCancel').onclick = ()=> $('#modalAdmin').style.display='none';
    $('#adminOk').onclick = ()=>{
      if($('#adminCode').value.trim()==='2525'){
        isAdminUI=true; $('#modalAdmin').style.display='none'; toggleFab(); refreshAdminFlags();
      } else { $('#adminMsg').textContent='Code incorrect.'; }
    };

    /* ---------- FAB : ajout chapitre OU cours ---------- */
    const fab = $('#fabAdd');
    function toggleFab(){
      const id = activeId();
      let show = false, action = '';
      if(isAdminUI && id==='scr-chapters'){ show=true; action='chapter'; }
      if(isAdminUI && id==='scr-courses'){ show=true; action='course'; }
      fab.style.display = show ? 'grid' : 'none';
      fab.dataset.action = action;
    }
    fab.onclick = ()=>{
      if(fab.dataset.action==='chapter'){
        // ouvrir modal chapitre
        $('#chapName').value=''; $('#chapMsg').textContent='';
        $('#modalChapter').style.display='flex';
      }else if(fab.dataset.action==='course'){
        // ouvrir modal cours multi
        $('#addImg').value=''; $('#addMsg').textContent='';
        $('#modalAdd').style.display='flex';
      }
    };

    // Ajout CHAPITRE
    $('#chapCancel').onclick = ()=> $('#modalChapter').style.display='none';
    $('#chapSave').onclick = async ()=>{
      const name = ($('#chapName').value||'').trim();
      const out = $('#chapMsg');
      if(!name){ out.textContent='Entre un nom de chapitre.'; return; }
      try{
        const start = (chapterOrderMaxBySubject[currentSubject] ?? -1) + 1;
        await addDoc(collection(db, `subjects/${currentSubject}/chapters`), {
          name, order:start, createdAt: Date.now()
        });
        $('#modalChapter').style.display='none';
      }catch(e){ out.textContent="Impossible d'ajouter ce chapitre."; }
    };

    // Ajout COURS (multi) dans le chapitre courant
    $('#addCancel').onclick = ()=> $('#modalAdd').style.display='none';
    $('#addSave').onclick = async ()=>{
      const files = Array.from($('#addImg').files || []);
      const out = $('#addMsg');
      if(!files.length){ out.textContent='Choisis au moins une image.'; return; }
      if(!currentChapter){ out.textContent='Pas de chapitre s√©lectionn√©.'; return; }
      out.textContent = 'Compression et enregistrement...';
      try{
        const key = `${currentSubject}/${currentChapter.id}`;
        let start = (courseOrderMaxByChap[key] ?? -1) + 1;
        const path = `subjects/${currentSubject}/chapters/${currentChapter.id}/courses`;

        for(let i=0;i<files.length;i++){
          const imgURL = await compressAndUpload(files[i], 1280, .8);
          await addDoc(collection(db, path), {
            img: imgURL, order: start + i, createdAt: Date.now() + i
          });
        }
        $('#modalAdd').style.display='none';
      }catch(e){
        out.textContent="√âchec de l'enregistrement. Essaie avec des images plus petites.";
      }
    };

    // Compression locale -> dataURL
    async function compressAndUpload(file, max=1280, quality=.8){
      const url = URL.createObjectURL(file);
      const img = await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });
      let {width:w, height:h} = img;
      if (Math.max(w,h)>max) {
        if (w>h){ h = Math.round(h*max/w); w = max; } else { w = Math.round(w*max/h); h = max; }
      }
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      URL.revokeObjectURL(url);
      return canvas.toDataURL('image/jpeg', quality);
    }

    /* ---------- Init ---------- */
    window.addEventListener('load', ()=>{
      const name = (localStorage.getItem('prenom')||'').trim();
      if(name){ who.textContent=name; document.getElementById('scr-welcome').classList.remove('active'); document.getElementById('scr-home').classList.add('active'); navStack[0]='scr-home'; }
      setStackHeight(activeScreen().scrollHeight);
      refreshBack(); toggleFab();
    });
    window.addEventListener('resize', ()=> setStackHeight(activeScreen().scrollHeight));
  </script>
</body>
</html>
