<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Espace de cours</title>
  <style>
    :root{
      --pad:18px; --safe-top:env(safe-area-inset-top); --safe-bottom:env(safe-area-inset-bottom);
      --ink:#000; --bg:#fff; --fg:#111;
      --radius:18px; --thick:4px; --dur:300ms; --ease:cubic-bezier(.2,.7,.3,1);
      --gap:10px;
      --c-fr:#fac3cf; --c-his:#ffd9b3; --c-svt:#c9f0db; --c-chi:#fff3b8;
      --c-snt:#cfeeff; --c-ses:#f1dbff; --c-ang:#ffc6e9;
    }
    *{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:700 clamp(16px,2.6vw,18px)/1.25 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    .app{
      max-width: 400px;
      margin: 0 auto;
      padding: calc(var(--safe-top) + var(--pad)) var(--pad) calc(var(--safe-bottom) + var(--pad));
      min-height: 100svh;
      position: relative;
    }
    /* barre haute : engrenage (gauche) puis flèche retour */
    header.bar{
      position: sticky; top: calc(var(--safe-top) + 6px);
      display:flex; gap:8px; align-items:center; justify-content:flex-start;
      z-index:5;
    }
    .iconBtn{
      width:40px;height:40px;border:3px solid var(--ink);
      border-radius:50%; display:grid; place-items:center;
      background:#fff; color:#000; cursor:pointer;
    }
    #backBtn{ visibility:hidden; }

    h1{margin:14px 0 20px; font-size:clamp(26px,7vw,36px); line-height:1.1; text-align:center}
    h2{margin:6px 0 14px; font-size:clamp(22px,6.5vw,30px); text-align:center}

    label{display:block; margin:8px 0 6px}
    input[type="text"], input[type="file"]{
      width:100%; padding:14px; border-radius:16px;
      border:var(--thick) solid var(--ink);
      background:#ececec; font: 800 17px/1.2 system-ui; color:#000; outline:none;
    }
    .btn{
      margin-top:14px; padding:12px 16px; border:3px solid var(--ink);
      border-radius:14px; background:#000; color:#fff; font:800 17px system-ui; cursor:pointer;
      width:fit-content;
    }
    .btn.secondary{background:#fff; color:#000}
    .btn:active{transform:translateY(1px)}
    .hint{margin-top:8px; opacity:.65; font-weight:600}

    /* pile + transitions */
    .stack{ position:relative }
    .screen{
      position:absolute; inset:0; opacity:0; pointer-events:none; transform:translateX(40px);
      display:flex; flex-direction:column;
    }
    .screen.active{ opacity:1; pointer-events:auto; transform:none }
    .anim-out-left{animation:outLeft var(--dur) var(--ease) both}
    .anim-in-right{animation:inRight var(--dur) var(--ease) both}
    .anim-out-right{animation:outRight var(--dur) var(--ease) both}
    .anim-in-left{animation:inLeft var(--dur) var(--ease) both}
    @keyframes outLeft{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(-40px)}}
    @keyframes inRight{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
    @keyframes outRight{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(40px)}}
    @keyframes inLeft{from{opacity:0;transform:translateX(-40px)}to{opacity:1;transform:translateX(0)}}

    .center{ flex:1; display:flex; flex-direction:column; justify-content:center; gap:16px }

    /* cartes */
    .menu{display:flex; flex-direction:column; gap:14px}
    .cardLink, .mat{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px; background:#e5e5e5; border:var(--thick) solid var(--ink);
      border-radius:20px; text-decoration:none; color:#000; cursor:pointer;
      font-size:clamp(18px,5vw,22px); font-weight:900; box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .pillArrow{min-width:52px;height:38px;border:3px solid var(--ink);border-radius:999px;display:grid;place-items:center;background:#fff;color:#000}
    .list{display:flex;flex-direction:column;gap:12px;margin-top:6px}
    .left{display:flex;align-items:center;gap:10px}
    .icon{font-size:1.1em}

    /* titre matière */
    .subjectTitle{ font-size: clamp(28px,8vw,38px); text-align:center; margin: 6px 0 8px }

    /* carrousel swipe */
    .sliderWrap{ position:relative; overflow:hidden; margin-top:6px }
    .slides{ display:flex; gap:var(--gap); transition:transform 260ms var(--ease) }
    .slide{
      border:var(--thick) solid var(--ink); border-radius:16px;
      width:120px; flex:0 0 auto; display:flex; flex-direction:column; overflow:hidden;
      background:#dcdcdc; box-shadow:0 6px 14px rgba(0,0,0,.06); cursor:pointer; touch-action:pan-y;
    }
    .imgWrap{ height:130px; background:#d0d0d0; display:grid; place-items:center }
    .slide img{ width:100%; height:100%; object-fit:cover }
    /* .caption supprimée puisque plus de date */
    /* .caption{ padding:6px 8px; text-align:center; background:#fff; border-top:var(--thick) solid var(--ink); font-weight:900 } */

    /* FAB admin */
    .fab{
      position:fixed; right:22px; bottom:calc(22px + var(--safe-bottom));
      width:56px;height:56px;border-radius:50%; border:3px solid var(--ink);
      background:#000; color:#fff; display:none; place-items:center; font-size:26px;
      box-shadow:0 8px 18px rgba(0,0,0,.18); cursor:pointer; z-index:7;
    }

    /* modales */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:8}
    .modal .box{background:#fff; color:#000; border:var(--thick) solid var(--ink); border-radius:18px; padding:16px; width:min(92vw,380px)}
    .modal .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}

    /* viewer image */
    .viewer{position:fixed; inset:0; background:#000; display:none; align-items:center; justify-content:center; z-index:9}
    .viewer img{max-width:96vw; max-height:90vh; border-radius:12px}
    .viewer .close{position:fixed; top:16px; right:16px; width:42px;height:42px;border:3px solid #fff;border-radius:50%;color:#fff;display:grid;place-items:center;cursor:pointer}
  </style>
</head>
<body>
  <main class="app">
    <header class="bar">
      <button id="gear" class="iconBtn" title="Paramètres">⚙️</button>
      <button id="backBtn" class="iconBtn" aria-label="Retour">←</button>
    </header>

    <div id="stack" class="stack" aria-live="polite" aria-atomic="true">
      <!-- 1) prénom -->
      <section id="scr-welcome" class="screen active">
        <div class="center">
          <h1>Bienvenue dans ton espace de cours</h1>
          <div>
            <label for="prenom">Quel est ton prénom ?</label>
            <input id="prenom" type="text" placeholder="Ton prénom" autocomplete="given-name">
            <button id="go" class="btn">Continuer</button>
            <div id="msg" class="hint"></div>
          </div>
        </div>
      </section>

      <!-- 2) menu -->
      <section id="scr-home" class="screen" aria-hidden="true">
        <div class="center">
          <h2>Bonjour <span id="who">prenom</span></h2>
          <nav class="menu">
            <button id="btn-cours"   class="cardLink" type="button">cours <span class="pillArrow">→</span></button>
            <button id="btn-emploi"  class="cardLink" type="button">emploie du temps <span class="pillArrow">→</span></button>
            <button id="btn-devoirs" class="cardLink" type="button">devoirs <span class="pillArrow">→</span></button>
            <button id="btn-controle"class="cardLink" type="button">controle <span class="pillArrow">→</span></button>
          </nav>
        </div>
      </section>

      <!-- 3) liste des matières -->
      <section id="scr-cours" class="screen" aria-hidden="true">
        <h2 style="margin-top:4px">Cours</h2>
        <div id="mat-list" class="list"></div>
      </section>

      <!-- 4) détail matière -->
      <section id="scr-subject" class="screen" aria-hidden="true">
        <h2 id="subjectTitle" class="subjectTitle">matière</h2>
        <div class="sliderWrap" id="sliderWrap">
          <div id="slides" class="slides"></div>
        </div>
        <!-- Recherche par date supprimée -->
      </section>
    </div>

    <!-- FAB admin -->
    <button id="fabAdd" class="fab" title="Ajouter un cours">＋</button>

    <!-- Modal paramètres -->
    <div id="modalGear" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Paramètres</h3>
        <div id="adminRow"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="gearClose">Fermer</button>
        </div>
      </div>
    </div>

    <!-- Modal admin -->
    <div id="modalAdmin" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Mode admin</h3>
        <label for="adminCode">Code</label>
        <input id="adminCode" type="text" inputmode="numeric" maxlength="8" placeholder="Code admin">
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="adminCancel">Annuler</button>
          <button class="btn" id="adminOk">Valider</button>
        </div>
        <div id="adminMsg" class="hint"></div>
      </div>
    </div>

    <!-- Modal ajout cours -->
    <div id="modalAdd" class="modal">
      <div class="box">
        <h3 style="margin:0 0 8px">Ajouter un cours</h3>
        <label>Image</label>
        <input id="addImg" type="file" accept="image/*" capture="environment">
        <div class="row" style="justify-content:flex-end">
          <button class="btn secondary" id="addCancel">Annuler</button>
          <button class="btn" id="addSave">Enregistrer</button>
        </div>
        <div id="addMsg" class="hint"></div>
      </div>
    </div>

    <!-- Viewer image -->
    <div id="viewer" class="viewer">
      <button class="close" id="viewerClose">✕</button>
      <img id="viewerImg" alt="Cours">
    </div>
  </main>

  <!-- =========================
       SCRIPT (Firebase + UI)
       ========================= -->
  <script type="module">
    /* ---------- Firebase (Firestore only) ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // >>>>>>> Ta configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBdfzyOuEWW7kcvPAxruh_Oxz3WJHyMBnE",
      authDomain: "app-cours-94f32.firebaseapp.com",
      projectId: "app-cours-94f32",
      storageBucket: "app-cours-94f32.firebasestorage.app",
      messagingSenderId: "519755746540",
      appId: "1:519755746540:web:8d55f18754ce08884269c9",
      measurementId: "G-VD89GYHJWV"
    };
    // <<<<<<<

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    /* ---------- helpers UI ---------- */
    const $ = s => document.querySelector(s);
    const stack = $('#stack');
    const backBtn = $('#backBtn');

    function setStackHeight(h){ stack.style.height = h+'px'; }
    const navStack = ['scr-welcome'];
    function activeId(){ return navStack[navStack.length-1]; }
    function activeScreen(){ return document.getElementById(activeId()); }
    function canGoBack(){ return navStack.length>1; }
    function refreshBack(){ backBtn.style.visibility = canGoBack() ? 'visible' : 'hidden'; }

    function animate(fromEl,toEl,dir){
      setStackHeight(Math.max(fromEl.scrollHeight,toEl.scrollHeight));
      fromEl.classList.remove('active'); toEl.classList.add('active');
      const o = dir==='f' ? 'anim-out-left':'anim-out-right';
      const i = dir==='f' ? 'anim-in-right':'anim-in-left';
      fromEl.classList.add(o); toEl.classList.add(i);
      toEl.addEventListener('animationend',()=>{
        fromEl.classList.remove(o); toEl.classList.remove(i);
        setStackHeight(toEl.scrollHeight);
      },{once:true});
    }
    function go(id,dir='f'){ const a=activeScreen(); const b=document.getElementById(id); if(a===b) return; navStack.push(id); animate(a,b,dir); refreshBack(); toggleFab(); }
    function back(){ if(!canGoBack()) return; const a=activeScreen(); navStack.pop(); const b=activeScreen(); animate(a,b,'b'); refreshBack(); toggleFab(); }
    backBtn.onclick = back;

    /* ---------- Etat ----------- */
    const who = $('#who'), prenomInput = $('#prenom'), msg = $('#msg');
    let isAdminUI = false;
    let currentSubject = null;
    let unsubscribe = null;

    const subjects = [
      {slug:'francais', name:'francais', color:'var(--c-fr)',  icon:'📚'},
      {slug:'histoire', name:'histoire', color:'var(--c-his)', icon:'🏛️'},
      {slug:'svt',      name:'SVT',      color:'var(--c-svt)', icon:'🧬'},
      {slug:'chimie',   name:'Chimie',   color:'var(--c-chi)', icon:'⚗️'},
      {slug:'snt',      name:'SNT',      color:'var(--c-snt)', icon:'💻'},
      {slug:'ses',      name:'SES',      color:'var(--c-ses)', icon:'📈'},
      {slug:'anglais',  name:'Anglais',  color:'var(--c-ang)', icon:'🇬🇧'}
    ];

    /* ---------- Accueil ---------- */
    function saveAndGo(){
      const name = (prenomInput.value||'').trim();
      if(!name){ msg.textContent = "Entre ton prénom pour continuer."; return; }
      localStorage.setItem('prenom', name);
      who.textContent = name;
      msg.textContent = '';
      go('scr-home','f');
    }
    $('#go').onclick = saveAndGo;
    prenomInput.addEventListener('keydown', e=>{ if(e.key==='Enter') saveAndGo(); });

    /* ---------- Menu ---------- */
    $('#btn-cours').onclick   = ()=>{ renderMatieres(); go('scr-cours','f'); };
    $('#btn-emploi').onclick  = ()=> alert('Écran "emploie du temps" à venir');
    $('#btn-devoirs').onclick = ()=> alert('Écran "devoirs" à venir');
    $('#btn-controle').onclick= ()=> alert('Écran "controle" à venir');

    function renderMatieres(){
      const wrap = $('#mat-list'); wrap.innerHTML='';
      for(const s of subjects){
        const b = document.createElement('button');
        b.className='mat'; b.type='button'; b.style.background = s.color;
        b.innerHTML = `<span class="left"><span>${s.name}</span> <span class="icon">${s.icon}</span></span>
                       <span class="pillArrow">→</span>`;
        b.onclick = ()=> openSubject(s.slug);
        wrap.appendChild(b);
      }
    }

    /* ---------- Matière : rendu + écoute Firestore ---------- */
    const slidesEl = $('#slides'), sliderWrap = $('#sliderWrap');
    let slideW=120, idx=0;

    function openSubject(slug){
      currentSubject = slug;
      const s = subjects.find(x=>x.slug===slug);
      $('#subjectTitle').textContent = s.name;
      renderSubjectCloud(slug);
      go('scr-subject','f');
      setTimeout(()=>setStackHeight(activeScreen().scrollHeight),10);
    }

    function renderSubjectCloud(slug){
      if (unsubscribe) { unsubscribe(); unsubscribe=null; }
      slidesEl.innerHTML = '';
      // tri par date de création (plus récents en premier)
      const q = query(collection(db, `subjects/${slug}/courses`), orderBy("createdAt","desc"));
      unsubscribe = onSnapshot(q, snap=>{
        const arr=[]; snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
        slidesEl.innerHTML = '';
        if(!arr.length){
          slidesEl.innerHTML = '<div class="hint" style="margin:8px auto">Aucun cours pour le moment.</div>';
        }else{
          for(const it of arr){
            const card = document.createElement('div');
            card.className='slide';
            const imgWrap=document.createElement('div'); imgWrap.className='imgWrap';
            if(it.img){ const im=new Image(); im.src=it.img; imgWrap.appendChild(im); }
            card.appendChild(imgWrap);
            card.onclick = ()=> openViewer(it.img);
            slidesEl.appendChild(card);
          }
        }
        layoutSlides(); moveTo(0,false);
        setTimeout(()=>setStackHeight(activeScreen().scrollHeight),10);
      });
    }

    function layoutSlides(){
      const w = sliderWrap.clientWidth;
      const gap = parseInt(getComputedStyle(slidesEl).gap||'10');
      slideW = Math.floor((w - 2*gap)/3);
      [...slidesEl.children].forEach(s=> s.style.width = slideW+'px');
    }
    function moveTo(i, animate=true){
      const n = slidesEl.children.length || 1;
      idx = Math.max(0, Math.min(n-1, i));
      if(!animate) slidesEl.style.transition='none';
      const offset = -(idx * (slideW + parseInt(getComputedStyle(slidesEl).gap||'10')));
      slidesEl.style.transform = `translateX(${offset}px)`;
      if(!animate){ void slidesEl.offsetWidth; slidesEl.style.transition='transform 260ms var(--ease)'; }
    }

    // swipe
    let startX=0, dragging=false, baseX=0;
    sliderWrap.addEventListener('pointerdown', e=>{
      if(!slidesEl.children.length) return;
      dragging=true; startX=e.clientX; slidesEl.style.transition='none';
      const tr = getComputedStyle(slidesEl).transform;
      const m = tr==='none' ? [1,0,0,1,0,0] : tr.match(/matrix\(([^)]+)\)/)[1].split(',').map(Number);
      baseX = m[4] || 0;
      sliderWrap.setPointerCapture(e.pointerId);
    });
    sliderWrap.addEventListener('pointermove', e=>{
      if(!dragging) return;
      const dx = e.clientX - startX;
      slidesEl.style.transform = `translateX(${baseX + dx}px)`;
    });
    sliderWrap.addEventListener('pointerup', e=>{
      if(!dragging) return; dragging=false; slidesEl.style.transition='transform 260ms var(--ease)';
      const dx = e.clientX - startX;
      const thr = 40;
      if(Math.abs(dx) > thr){ moveTo(idx - Math.sign(dx)); }
      else { moveTo(idx, true); }
    });
    window.addEventListener('resize', ()=>{ if(document.getElementById('scr-subject').classList.contains('active')){ layoutSlides(); moveTo(idx,false); setStackHeight(activeScreen().scrollHeight);} });

    /* ---------- viewer ---------- */
    function openViewer(src){ if(!src) return; $('#viewerImg').src=src; $('#viewer').style.display='flex'; }
    $('#viewerClose').onclick = ()=> $('#viewer').style.display='none';

    /* ---------- Paramètres + Admin (UI code 2525) ---------- */
    const modalGear = $('#modalGear'), adminRow = $('#adminRow');
    function refreshGear(){
      adminRow.innerHTML='';
      const b = document.createElement('button');
      b.className='btn'; b.textContent = isAdminUI ? 'Quitter admin' : 'Admin';
      b.onclick = ()=>{
        if(isAdminUI){ isAdminUI=false; toggleFab(); modalGear.style.display='none'; }
        else{ modalGear.style.display='none'; openAdminModal(); }
      };
      adminRow.appendChild(b);
    }
    function openAdminModal(){
      $('#adminCode').value=''; $('#adminMsg').textContent='';
      $('#modalAdmin').style.display='flex';
    }
    $('#gear').onclick = ()=>{ refreshGear(); modalGear.style.display='flex'; };
    $('#gearClose').onclick = ()=> modalGear.style.display='none';
    $('#adminCancel').onclick = ()=> $('#modalAdmin').style.display='none';
    $('#adminOk').onclick = ()=>{
      if($('#adminCode').value.trim()==='2525'){
        isAdminUI=true; $('#modalAdmin').style.display='none'; toggleFab();
      } else { $('#adminMsg').textContent='Code incorrect.'; }
    };

    /* ---------- Ajout cours (image en base64 stockée dans Firestore) ---------- */
    function toggleFab(){
      const onSubject = activeId()==='scr-subject';
      $('#fabAdd').style.display = (isAdminUI && onSubject) ? 'grid' : 'none';
    }
    $('#fabAdd').onclick = ()=>{ $('#addImg').value=''; $('#addMsg').textContent=''; $('#modalAdd').style.display='flex'; };
    $('#addCancel').onclick = ()=> $('#modalAdd').style.display='none';
    $('#addSave').onclick = async ()=>{
      const f = $('#addImg').files[0], out = $('#addMsg');
      if(!f){ out.textContent='Choisis une image.'; return; }
      try{
        const imgURL = await compressAndUpload(f, 1280, .8, currentSubject); // retourne une dataURL
        await addDoc(collection(db, `subjects/${currentSubject}/courses`), { img:imgURL, createdAt:Date.now() });
        $('#modalAdd').style.display='none';
      }catch(e){
        out.textContent="Échec de l'enregistrement. Essaie avec une image plus petite.";
      }
    };

    // Compression locale -> dataURL (aucun upload Storage)
    async function compressAndUpload(file, max=1280, quality=.8){
      const url = URL.createObjectURL(file);
      const img = await new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });
      let {width:w, height:h} = img;
      if (Math.max(w,h)>max) {
        if (w>h){ h = Math.round(h*max/w); w = max; } else { w = Math.round(w*max/h); h = max; }
      }
      const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      URL.revokeObjectURL(url);
      return canvas.toDataURL('image/jpeg', quality);
    }

    /* ---------- Init ---------- */
    window.addEventListener('load', ()=>{
      const name = (localStorage.getItem('prenom')||'').trim();
      if(name){ who.textContent=name; document.getElementById('scr-welcome').classList.remove('active'); document.getElementById('scr-home').classList.add('active'); navStack[0]='scr-home'; }
      setStackHeight(activeScreen().scrollHeight);
      refreshBack(); toggleFab();
    });
    window.addEventListener('resize', ()=> setStackHeight(activeScreen().scrollHeight));
  </script>
</body>
</html>
