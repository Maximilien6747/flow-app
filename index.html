<script>
  /* ===== Helpers dates ===== */
  function toISODate(d){const tz=d.getTimezoneOffset()*60000;const local=new Date(d.getTime()-tz);return local.toISOString().slice(0,10)}
  function fromISODate(s){const [y,m,dd]=s.split("-").map(Number);return new Date(y,m-1,dd)}
  function todayISO(){return toISODate(new Date())}

  /* ===== Clés de stockage ===== */
  const PROFILE_KEY = "flowProfile";   // {nom, age, email, sexe}
  const TASKS_KEY   = "flowTasks";     // { "YYYY-MM-DD": [ {text,done}, ... ] }

  /* ===== State ===== */
  const state = { nom:"", age:"", email:"", sexe:"", currentDate: todayISO() };

  /* ===== Profile load/save ===== */
  function loadProfile(){
    try { return JSON.parse(localStorage.getItem(PROFILE_KEY)) || null; }
    catch { return null; }
  }
  function saveProfile(p){ localStorage.setItem(PROFILE_KEY, JSON.stringify(p)); }
  function clearProfile(){ localStorage.removeItem(PROFILE_KEY); }

  /* ===== Tasks load/save ===== */
  function loadAllTasks(){ try{ return JSON.parse(localStorage.getItem(TASKS_KEY)) || {}; } catch{ return {}; } }
  function saveAllTasks(data){ localStorage.setItem(TASKS_KEY, JSON.stringify(data)); }
  function loadTasksFor(date){ const all=loadAllTasks(); return Array.isArray(all[date])?all[date]:[]; }
  function saveTasksFor(date, tasks){ const all=loadAllTasks(); all[date]=tasks; saveAllTasks(all); }

  /* Seed tâches du jour au 1er lancement */
  (function seed(){
    const all = loadAllTasks(); const today = todayISO();
    if(!all[today]){
      all[today] = [
        { text:"Peindre la voiture", done:false },
        { text:"Peindre le chat",   done:false },
        { text:"Peindre la maison", done:false },
      ];
      saveAllTasks(all);
    }
  })();

  /* ===== Navigation d’écrans ===== */
  const screens = [...document.querySelectorAll(".screen")];
  function show(id){
    screens.forEach(s => s.classList.toggle("active", s.id === id));
    if(id==="s2") document.getElementById("nom").focus();
    if(id==="s3") document.getElementById("age").focus();
    if(id==="s4") document.getElementById("email").focus();
    if(id==="s5") document.getElementById("sexe").focus();
    if(id==="s7"){
      // Personnalisation & init UI
      document.getElementById("hello").textContent = state.nom ? `Votre flow, ${state.nom}` : "Votre flow";
      const picker = document.getElementById("dayPicker");
      picker.value = state.currentDate;
      renderTasks();
      document.getElementById("newTask").focus();

      // Ajoute un bouton "Réinitialiser le profil" si absent
      const bar = document.querySelector(".taskbar");
      if(!document.getElementById("resetProfile")){
        const reset = document.createElement("button");
        reset.id = "resetProfile"; reset.className = "btn small"; reset.textContent = "Réinitialiser le profil";
        reset.addEventListener("click", ()=>{ clearProfile(); show("s1"); });
        bar.appendChild(reset);
      }
    }
  }

  // Boutons "Continuer" entre les écrans
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-next]");
    if(!btn) return;
    const current = document.querySelector(".screen.active")?.id;

    // Capture des champs au vol
    if(current==="s2") state.nom   = (document.getElementById("nom").value   || "").trim();
    if(current==="s3") state.age   = (document.getElementById("age").value   || "").trim();
    if(current==="s4") state.email = (document.getElementById("email").value || "").trim();

    // Quand on quitte l’écran "sexe", on SAUVEGARDE le profil
    if(current==="s5"){
      state.sexe = document.getElementById("sexe").value;
      saveProfile({ nom: state.nom, age: state.age, email: state.email, sexe: state.sexe });
    }

    show(btn.dataset.next);
  });

  // Entrée pour avancer
  document.getElementById("nom").addEventListener("keydown", e => { if(e.key==="Enter") show("s3"); });
  document.getElementById("age").addEventListener("keydown", e => { if(e.key==="Enter") show("s4"); });
  document.getElementById("email").addEventListener("keydown", e => { if(e.key==="Enter") show("s5"); });
  document.getElementById("sexe").addEventListener("keydown", e => { if(e.key==="Enter") { 
    state.sexe = document.getElementById("sexe").value; 
    saveProfile({ nom: state.nom, age: state.age, email: state.email, sexe: state.sexe });
    show("s6"); 
  }});

  /* ===== To-Do : rendu & interactions ===== */
  function renderTasks(){
    const list = document.getElementById("tasklist");
    list.innerHTML = "";
    const tasks = loadTasksFor(state.currentDate);
    if(tasks.length === 0){
      const empty = document.createElement("p"); empty.className = "hint"; empty.textContent = "Aucune tâche pour ce jour.";
      list.appendChild(empty); return;
    }
    tasks.forEach((t, idx) => {
      const item = document.createElement("div");
      item.className = "task" + (t.done ? " done" : ""); item.dataset.index = String(idx);

      const text = document.createElement("span"); text.className = "text"; text.textContent = t.text;
      const circle = document.createElement("button"); circle.className = "circle"; circle.textContent = "✓"; circle.setAttribute("aria-label","Effectuer la tâche");

      item.append(text, circle); list.appendChild(item);
    });
  }
  document.getElementById("tasklist").addEventListener("click", (e) => {
    const circle = e.target.closest(".circle"); if(!circle) return;
    const item = circle.closest(".task"); const idx = Number(item.dataset.index);
    const tasks = loadTasksFor(state.currentDate);
    if(tasks[idx]){ tasks[idx].done = !tasks[idx].done; saveTasksFor(state.currentDate, tasks); renderTasks(); }
  });

  // Ajouter une tâche
  function addTask(){
    const input = document.getElementById("newTask");
    const txt = (input.value || "").trim(); if(!txt) return;
    const tasks = loadTasksFor(state.currentDate);
    tasks.push({ text: txt, done: false });
    saveTasksFor(state.currentDate, tasks);
    input.value = ""; renderTasks();
  }
  document.getElementById("addTask").addEventListener("click", addTask);
  document.getElementById("newTask").addEventListener("keydown", (e) => { if(e.key === "Enter") addTask(); });

  // Navigation entre jours
  const picker = document.getElementById("dayPicker");
  document.getElementById("prevDay").addEventListener("click", () => { const d=fromISODate(state.currentDate); d.setDate(d.getDate()-1); state.currentDate=toISODate(d); picker.value=state.currentDate; renderTasks(); });
  document.getElementById("nextDay").addEventListener("click", () => { const d=fromISODate(state.currentDate); d.setDate(d.getDate()+1); state.currentDate=toISODate(d); picker.value=state.currentDate; renderTasks(); });
  document.getElementById("goToday").addEventListener("click", () => { state.currentDate=todayISO(); picker.value=state.currentDate; renderTasks(); });
  picker.addEventListener("change", () => { state.currentDate = picker.value || todayISO(); renderTasks(); });

  /* ===== Démarrage : si profil déjà enregistré → saute l’onboarding ===== */
  window.addEventListener("load", () => {
    const saved = loadProfile();
    if(saved){
      Object.assign(state, saved);              // remet nom/âge/email/sexe
      state.currentDate = todayISO();           // démarre sur aujourd’hui
      show("s7");                               // arrive direct sur la To-Do
    }else{
      show("s1");                               // parcours d’accueil la 1ère fois
    }

    // PWA / Service Worker (ok en HTTPS/GitHub Pages)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    }
  });
</script>
